<div class="grid">
    <div class="col-12 md:col-12">
        <p-table 
    #dt 
    styleClass="p-datatable-gridlines p-datatable-sm" 
    [value]="voyages" 
    [columns]="cols"
    [rows]="5" 
    [paginator]="true" 
    [rowsPerPageOptions]="[5, 10, 20, 30]" 
    [showCurrentPageReport]="true"
    [globalFilterFields]="['vol.numeroVol', 'dateVoyage', 'aeroport.nomAeroport', 'StatutVoyage']"
    currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entrées"
    [(selection)]="selectedVoyage" 
    selectionMode="single" 
    [rowHover]="true" 
    dataKey="id" 
    [loading]="loading"
    [filterDelay]="300">

    <ng-template pTemplate="caption">
        <div class="flex justify-content-between flex-column sm:flex-row">
            <div class="flex gap-2">
                <p-button 
                    label="Filtrer par période" 
                    severity="info"
                    icon="pi pi-filter"
                    (onClick)="openFilterDialog()">
                </p-button>
                <p-button 
                    label="Réinitialiser" 
                    severity="secondary"
                    icon="pi pi-refresh"
                    (onClick)="resetFilters()">
                </p-button>
            </div>
            <div class="flex flex-column align-items-end">
                <span class="p-input-icon-left mb-2">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        #filter 
                        (input)="onGlobalFilter(dt, $event)"
                        placeholder="Rechercher" 
                        class="w-full" />
                </span>
                <small class="text-500" *ngIf="dateDebut && dateFin">
                    Période: {{dateDebut | date:'dd/MM/yyyy'}} - {{dateFin | date:'dd/MM/yyyy'}}
                    <span *ngIf="selectedStatuts.length > 0"> | Statuts: {{selectedStatuts.length}} sélectionné(s)</span>
                </small>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <!-- PREMIÈRE LIGNE : Titres des colonnes -->
        <tr>
            <th pSortableColumn="vol.numero">
                <div class="flex align-items-center gap-2">
                    N° Vol / Type
                    <p-sortIcon field="vol.numero"></p-sortIcon>
                </div>
            </th>
            <th pSortableColumn="nomVoyageur">
                <div class="flex align-items-center gap-2">
                    Passager
                    <p-sortIcon field="nomVoyageur"></p-sortIcon>
                </div>
            </th>
            <th>Itinéraire</th>
            <th pSortableColumn="motifVoyage">
                <div class="flex align-items-center gap-2">
                    Motif
                    <p-sortIcon field="motifVoyage"></p-sortIcon>
                </div>
            </th>
            <th pSortableColumn="dureeSejour">
                <div class="flex align-items-center gap-2">
                    Durée
                    <p-sortIcon field="dureeSejour"></p-sortIcon>
                </div>
            </th>
            <th pSortableColumn="statut">
                <div class="flex align-items-center gap-2">
                    Statut
                    <p-sortIcon field="statut"></p-sortIcon>
                </div>
            </th>
            <th class="text-center">Actions</th>
        </tr>
        
        <!-- DEUXIÈME LIGNE : Champs de recherche par colonne -->
        <tr>
            <th>
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filter($any($event.target).value, 'vol.numero', 'contains')"
                        placeholder="Rechercher"
                        class="w-full" />
                </span>
            </th>
            <th>
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filter($any($event.target).value, 'nomVoyageur', 'contains')"
                        placeholder="Rechercher"
                        class="w-full" />
                </span>
            </th>
            <th>
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filter($any($event.target).value, 'vol.aeroport.nomAeroport', 'contains')"
                        placeholder="Rechercher"
                        class="w-full" />
                </span>
            </th>
            <th>
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filter($any($event.target).value, 'motifVoyage', 'contains')"
                        placeholder="Rechercher"
                        class="w-full" />
                </span>
            </th>
            <th>
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filter($any($event.target).value, 'dureeSejour', 'contains')"
                        placeholder="Rechercher"
                        class="w-full" />
                </span>
            </th>
            <th>
                <span class="p-input-icon-left w-full">
                    <i class="pi pi-search"></i>
                    <input 
                        pInputText 
                        type="text" 
                        (input)="dt.filter($any($event.target).value, 'statut', 'contains')"
                        placeholder="Rechercher"
                        class="w-full" />
                </span>
            </th>
            <th></th> <!-- Colonne actions sans filtre -->
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-voyage>
        <tr >
            <td>
                <div class="font-semibold">{{ voyage?.vol?.numero }} {{ voyage?.vol?.typeVol }}</div>
            </td>

            <!-- Colonne Passager -->
            <td>
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-user text-primary"></i>
                    <span class="font-semibold">{{ getPassagerFormate(voyage) }}</span>
                </div>
            </td>

            <!-- Colonne Itinéraire -->
            <td>
                <div class="flex align-items-center gap-2">
                    <span *ngIf="voyage?.vol?.typeVol == 'ARRIVEE'">
                        {{ voyage?.vol?.aeroport?.nomAeroport }}
                    </span>
                    <span *ngIf="voyage?.vol?.typeVol != 'ARRIVEE'">
                        {{ voyage?.nomAgentConnecteAeroport }}
                    </span>

                    <i class="pi pi-arrow-right text-color-secondary"></i>

                    <span *ngIf="voyage?.vol?.typeVol == 'ARRIVEE'">
                        {{ voyage?.nomAgentConnecteAeroport }}
                    </span>
                    <span *ngIf="voyage?.vol?.typeVol != 'ARRIVEE'">
                        {{ voyage?.vol?.aeroport?.nomAeroport }}
                    </span>
                </div>
            </td>

            <!-- Colonne Motif -->
            <td>{{ voyage?.motifVoyage }}</td>

            <!-- Colonne Durée -->
            <td>{{ voyage?.dureeSejour }} jours</td>

            <!-- Colonne Statut -->
            <td>
                <p-tag 
                    [value]="voyage?.statut || 'N/A'"
                    [severity]="getStatutSeverity(voyage?.statut)">
                </p-tag>
            </td>

            <!-- Colonne Actions -->
            <td class="text-center">
                <div class="flex align-items-center justify-content-center gap-2">
                    <p-button 
                        icon="pi pi-eye" 
                        [rounded]="true"
                        [text]="true"
                        severity="info"
                        pTooltip="Voir détail" 
                        tooltipPosition="top" 
                        (onClick)="openDetailModal(voyage)">
                    </p-button>

                    <p-button 
                        icon="pi pi-print" 
                        [rounded]="true"
                        [text]="true"
                        severity="success"
                        pTooltip="Imprimer fiche de voyage" 
                        tooltipPosition="top"
                        (onClick)="imprimerFicheVoyage(voyage)">
                    </p-button>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="7" class="text-center py-5">
                <div class="flex flex-column align-items-center justify-content-center gap-3">
                    <i class="pi pi-inbox text-5xl text-color-secondary"></i>
                    <span class="text-xl font-semibold text-red-500">Aucun vol trouvé !</span>
                    <span class="text-color-secondary">Essayez de modifier vos critères de recherche</span>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="loadingbody">
        <tr>
            <td colspan="7">
                <div class="flex align-items-center justify-content-center gap-2 py-3">
                    <i class="pi pi-spin pi-spinner text-2xl"></i>
                    <span>Chargement des données...</span>
                </div>
            </td>
        </tr>
    </ng-template>
</p-table>
    </div>
</div>

<p-dialog [(visible)]="filterDialog" [modal]="true" [draggable]="false" [resizable]="false" [style]="{width: '500px'}"
    header="Filtrer les voyages par période" styleClass="p-fluid">

    <ng-template pTemplate="content">
        <form [formGroup]="filterFormGroup">
            <div class="grid">
                <!-- Date de début -->
                <div class="col-12 md:col-6">
                    <label for="dateDebut" class="block mb-2 font-semibold">
                        Date de début <span class="text-red-500">*</span>
                    </label>
                    <p-calendar id="dateDebut" formControlName="dateDebut" dateFormat="dd/mm/yy" [showIcon]="true"
                        placeholder="Sélectionner une date" [maxDate]="filterFormGroup.get('dateFin')?.value">
                    </p-calendar>
                    <small class="text-red-500"
                        *ngIf="filterFormGroup.get('dateDebut')?.invalid && filterFormGroup.get('dateDebut')?.touched">
                        La date de début est requise
                    </small>
                </div>

                <!-- Date de fin -->
                <div class="col-12 md:col-6">
                    <label for="dateFin" class="block mb-2 font-semibold">
                        Date de fin <span class="text-red-500">*</span>
                    </label>
                    <p-calendar id="dateFin" formControlName="dateFin" dateFormat="dd/mm/yy" [showIcon]="true"
                        placeholder="Sélectionner une date" [minDate]="filterFormGroup.get('dateDebut')?.value">
                    </p-calendar>
                    <small class="text-red-500"
                        *ngIf="filterFormGroup.get('dateFin')?.invalid && filterFormGroup.get('dateFin')?.touched">
                        La date de fin est requise
                    </small>
                </div>

                <!-- Statuts -->
                <div class="col-12">
                    <label for="statutVoyages" class="block mb-2 font-semibold">
                        Statuts des vols
                    </label>
                    <p-multiSelect id="statutVoyages" formControlName="statutVoyages" appendTo="body"
                        [options]="statutsVoyage" optionLabel="label" optionValue="value"
                        placeholder="Sélectionner les statuts" [filter]="true" filterPlaceHolder="Rechercher..."
                        [showClear]="true" display="chip">
                    </p-multiSelect>

                    <small class="text-gray-500">
                        Cocher tout pour tous les statuts
                    </small>
                </div>
            </div>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <button pButton label="Annuler" icon="pi pi-times" class="p-button-text p-button-secondary"
                (click)="closeFilterDialog()">
            </button>
            <button pButton label="Réinitialiser" icon="pi pi-refresh" class="p-button-text p-button-warning"
                (click)="resetFilters()">
            </button>
            <button pButton label="Appliquer" icon="pi pi-check" class="p-button-primary"
                [disabled]="filterFormGroup.invalid" (click)="applyFilters()">
            </button>
        </div>
    </ng-template>
</p-dialog>


<p-dialog [(visible)]="isDetailModalOpen" [style]="{width: '1000px'}" header="Détails du voyage" [modal]="true"
    [closable]="true" [draggable]="false" [resizable]="false" class="p-fluid">

    <div class="p-fluid p-4">
        <!-- Section: Informations Générales du Voyage -->
        <p-fieldset legend="Informations Générales du Voyage" [toggleable]="true" [collapsed]="false" styleClass="mb-4">
            <div class="grid">
                


                <div class="field col-12 md:col-4">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-calendar mr-2"></i>Date du voyage:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.dateVoyage ? (selectedVoyage.dateVoyage | date: 'dd/MM/yyyy') : 'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-4">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-clock mr-2"></i>Heure du voyage:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.heureVoyage || 'N/A' }}</span>
                </div>






                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-map mr-2"></i>Aeroport de départ:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.vol?.aeroport?.nomAeroport || 'N/A' }}


                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-map-marker mr-2"></i>Aeroport d'arrivé:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.vol?.nomAgentConnecteAeroport|| selectedVoyage.villeNomA || 'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-info-circle mr-2"></i>Motif du voyage:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.motifVoyage?.libelle || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-hourglass mr-2"></i>Durée du séjour:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.dureeSejour ? selectedVoyage.dureeSejour + ' jour(s)' : 'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-ticket mr-2"></i>Statut du voyage:
                    </span>
                    <span class="ml-2" [ngClass]="{
                        'text-green-600 font-semibold': selectedVoyage.statut === 'ACTIF',
                        'text-yellow-600 font-semibold': selectedVoyage.statut === 'INACTIF',
                    }">

                        {{ selectedVoyage.statut || 'N/A' }}
                    </span>
                </div>


            </div>
        </p-fieldset>

        <!-- Section: Informations Personnelles du Voyageur -->
        <p-fieldset legend="Informations Personnelles" [toggleable]="true" [collapsed]="false" styleClass="mb-4">
            <div class="grid">
                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-user mr-2"></i>Nom de famille:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.nomVoyageur || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-user mr-2"></i>Prénom:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.prenomVoyageur || 'N/A' }}</span>
                </div>
            </div>
        </p-fieldset>

        <!-- Section: Informations sur le Vol -->
        <p-fieldset legend="Informations du Vol" [toggleable]="true" [collapsed]="true" styleClass="mb-4"
            *ngIf="selectedVoyage.vol">
            <div class="grid">
                <div class="field col-12 md:col-4">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-plane mr-2"></i>Numéro de vol:
                    </span>
                    <span class="ml-2 font-mono">{{ selectedVoyage.vol?.numero || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-4">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-building mr-2"></i>Compagnie:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.vol?.compagnie?.nomCompagine || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-4">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-tag mr-2"></i>Type de vol:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.vol?.typeVol || selectedVoyage.vol?.type || 'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-calendar-times mr-2"></i>Date de départ:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.vol?.dateDepart ? (selectedVoyage.vol.dateDepart | date: 'dd/MM/yyyy HH:mm') :
                        'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-calendar-plus mr-2"></i>Date d'arrivée:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.vol?.dateArrivee ? (selectedVoyage.vol.dateArrivee | date: 'dd/MM/yyyy HH:mm')
                        : 'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-flag mr-2"></i>Statut du vol:
                    </span>
                    <span class="ml-2" [ngClass]="{
        'text-green-600 font-semibold': selectedVoyage.vol?.statut === StatutVol.EFFECTUE,
        'text-blue-600 font-semibold': selectedVoyage.vol?.statut === StatutVol.CONFIRME,
        'text-red-600 font-semibold': selectedVoyage.vol?.statut === StatutVol.ANNULE,
        'text-yellow-600 font-semibold': selectedVoyage.vol?.statut === StatutVol.PROGRAMME || selectedVoyage.vol?.statut === StatutVol.RETARDE,
    }">
                        {{ selectedVoyage.vol?.statut || selectedVoyage.vol?.statutLibelle || 'N/A' }}
                    </span>
                </div>
                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-calendar mr-2"></i>Date de saisie:
                    </span>
                    <span class="ml-2">
                        {{ selectedVoyage.vol?.dateSaisie ? (selectedVoyage.vol.dateSaisie | date: 'dd/MM/yyyy') : 'N/A'
                        }}
                    </span>
                </div>
            </div>
        </p-fieldset>

        <!-- Section: Informations sur l'Aéroport -->
        <p-fieldset legend="Informations de l'Aéroport" [toggleable]="true" [collapsed]="true" styleClass="mb-4"
            *ngIf="selectedVoyage.aeroport || selectedVoyage.aeroportForUser">
            <div class="grid">
                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-building mr-2"></i>Nom de l'aéroport:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.aeroport?.nomAeroport ||
                        selectedVoyage.aeroportForUser?.nomAeroport || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-map mr-2"></i>Ville:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.aeroport?.ville?.nom ||
                        selectedVoyage.aeroportForUser?.ville?.nom || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-flag mr-2"></i>Pays:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.aeroport?.pays || selectedVoyage.aeroportForUser?.pays || 'N/A'
                        }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-tag mr-2"></i>Code OACI:
                    </span>
                    <span class="ml-2 font-mono">{{ selectedVoyage.aeroport?.code_oaci ||
                        selectedVoyage.aeroportForUser?.code_oaci || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-phone mr-2"></i>Téléphone:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.aeroport?.telephone ||
                        selectedVoyage.aeroportForUser?.telephone || 'N/A' }}</span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-globe mr-2"></i>Site web:
                    </span>
                    <span class="ml-2">
                        <a *ngIf="selectedVoyage.aeroport?.siteWeb || selectedVoyage.aeroportForUser?.siteWeb"
                            [href]="selectedVoyage.aeroport?.siteWeb || selectedVoyage.aeroportForUser?.siteWeb"
                            target="_blank" class="text-primary hover:underline">
                            {{ selectedVoyage.aeroport?.siteWeb || selectedVoyage.aeroportForUser?.siteWeb }}
                        </a>
                        <span
                            *ngIf="!(selectedVoyage.aeroport?.siteWeb || selectedVoyage.aeroportForUser?.siteWeb)">N/A</span>
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-envelope mr-2"></i>Email responsable:
                    </span>
                    <span class="ml-2">
                        <a *ngIf="selectedVoyage.aeroport?.mailResponsable || selectedVoyage.aeroportForUser?.mailResponsable"
                            [href]="'mailto:' + (selectedVoyage.aeroport?.mailResponsable || selectedVoyage.aeroportForUser?.mailResponsable)"
                            class="text-primary hover:underline">
                            {{ selectedVoyage.aeroport?.mailResponsable ||
                            selectedVoyage.aeroportForUser?.mailResponsable }}
                        </a>
                        <span
                            *ngIf="!(selectedVoyage.aeroport?.mailResponsable || selectedVoyage.aeroportForUser?.mailResponsable)">N/A</span>
                    </span>
                </div>

                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-user mr-2"></i>Responsable:
                    </span>
                    <span class="ml-2">
                        {{ (selectedVoyage.aeroport?.prenomResponsable ||
                        selectedVoyage.aeroportForUser?.prenomResponsable || '') + ' ' +
                        (selectedVoyage.aeroport?.nomResponsable || selectedVoyage.aeroportForUser?.nomResponsable ||
                        '') || 'N/A' }}
                    </span>
                </div>

                <div class="field col-12 md:col-12">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-home mr-2"></i>Adresse:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.aeroport?.adresse || selectedVoyage.aeroportForUser?.adresse ||
                        'N/A' }}</span>
                </div>
            </div>
        </p-fieldset>

        <!-- Section: Informations Administratives -->
        <p-fieldset legend="Informations Administratives" [toggleable]="true" [collapsed]="true" styleClass="mb-4">
            <div class="grid">
                <div class="field col-12 md:col-6">
                    <span class="font-bold text-gray-700">
                        <i class="pi pi-user-secret mr-2"></i>Agent connecté:
                    </span>
                    <span class="ml-2">{{ selectedVoyage.nomAgentConnecteAeroport ||
                        selectedVoyage.vol?.nomAgentConnecteAeroport || 'N/A' }}</span>
                </div>

            </div>
        </p-fieldset>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-between w-full">

            <button pButton pRipple label="Fermer" icon="pi pi-times" class="p-button-danger"
                (click)="closeDetailModal()">
            </button>
        </div>
    </ng-template>

</p-dialog>
<!-- Toast pour les notifications -->
<p-toast [style]="{marginTop: '80px'}" position="top-center"></p-toast>

<!-- Dialog de confirmation -->
<p-confirmDialog></p-confirmDialog>
<app-loading-spinner></app-loading-spinner>