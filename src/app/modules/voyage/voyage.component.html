<div class="grid">
    <div class="col-12 md:col-12">
        <p-table #dt styleClass="p-datatable-gridlines p-datatable-sm p-datatable" [value]="voyages" [columns]="cols"
            [rows]="5" [paginator]="true" [rowsPerPageOptions]="[5, 10, 20, 30]" [showCurrentPageReport]="true"
            [globalFilterFields]="['vol.numeroVol', 'dateVoyage', 'aeroport.nomAeroport','StatutVoyage']"
            currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} entrées"
            [(selection)]="selectedVoyage" selectionMode="single" [rowHover]="true" dataKey="id" [loading]="loading">

            <ng-template pTemplate="caption">
                <div class="flex justify-content-between flex-column sm:flex-row">
                    <div class="flex gap-2">
                       
                        <button pButton label="Filtrer par période" class="p-button-info mb-2" icon="pi pi-filter"
                            (click)="openFilterDialog()">
                        </button>
                        <button pButton label="Réinitialiser" class="p-button-secondary mb-2" icon="pi pi-refresh"
                            (click)="resetFilters()">
                        </button>
                    </div>
                    <div class="flex flex-column align-items-end">
                        <span class="p-input-icon-left mb-2">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" #filter (input)="onGlobalFilter(dt, $event)"
                                placeholder="Rechercher" class="w-full" />
                        </span>
                        <small class="text-500" *ngIf="dateDebut && dateFin">
                            Période: {{dateDebut | date:'dd/MM/yyyy'}} - {{dateFin | date:'dd/MM/yyyy'}}
                            <span *ngIf="selectedStatuts.length > 0"> | Statuts: {{selectedStatuts.length}}
                                sélectionné(s)</span>
                        </small>
                    </div>
                </div>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th style="font-weight: bold;">N° Vol / Type
                        <p-columnFilter type="text" display="menu" field="vol.numeroVol"></p-columnFilter>
                    </th>
                    <th style="font-weight: bold;">Passager
                        <p-columnFilter type="text" display="menu" field="nomVoyageur"></p-columnFilter>
                    </th>
                    <th style="width: 35%; font-weight: bold;">Itinéraire
                        <p-columnFilter type="text" display="menu" field="villeNomA"></p-columnFilter>
                    </th>
                    <th style="font-weight: bold;">Motif
                        <p-columnFilter type="text" display="menu" field="motifVoyage"></p-columnFilter>
                    </th>
                    <th style="font-weight: bold;">Durée
                        <p-columnFilter type="text" display="menu" field="dureeSejour"></p-columnFilter>
                    </th>
                    <th style="font-weight: bold;">Statut
                        <p-columnFilter type="text" display="menu" field="statut"></p-columnFilter>
                    </th>

                    <th style="font-weight: bold;" class="text-center">Actions</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-voyage>
                <tr>
                    <td class="table-separator">
                        <div class="text-sm font-medium text-gray-900">{{ voyage?.vol?.numero }}</div>
                    </td>
                    
                    <!-- Colonne Passager -->
                    <td class="table-separator">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-user text-primary"></i>
                            <span class="font-medium">{{ getPassagerFormate(voyage) }}</span>
                        </div>
                    </td>
                   
                    <td class="table-separator px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span *ngIf="voyage?.vol?.typeVol == 'ARRIVEE'">
                            {{ voyage?.vol?.aeroport?.nomAeroport }}
                        </span>
                        <span *ngIf="voyage?.vol?.typeVol != 'ARRIVEE'">
                            {{ voyage?.vol?.nomAgentConnecteAeroport }}
                        </span>
                        
                        <i class="fa-solid fa-arrow-right pi pi-arrow-right mr-2 mx-1 text-gray-400"></i>
                        
                        <span *ngIf="voyage?.vol?.typeVol == 'ARRIVEE'">
                            {{ voyage?.vol?.nomAgentConnecteAeroport }}
                        </span>
                        <span *ngIf="voyage?.vol?.typeVol != 'ARRIVEE'">
                            {{ voyage?.vol?.aeroport?.nomAeroport }}
                        </span>
                    </td>
                    <td class="table-separator">{{voyage?.motifVoyage}}</td>
                    <td class="table-separator">{{voyage?.dureeSejour}} jours</td>
                    <td class="table-separator">
                        <span [class]="'badge ' + getStatutClass(voyage?.vol?.statut)">
                            {{voyage?.statut || 'N/A'}}
                        </span>
                    </td>
                    <td class="text-center">
                        <button pButton icon="pi pi-eye" class="p-button-rounded p-button-primary mr-2"
                            pTooltip="Voir détail" tooltipPosition="top" (click)="openDetailModal(voyage)">
                        </button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="10" style="text-align: center; font-size: 1.2em; color: red; font-weight: bold;">
                        <span class="text-danger">Aucun vol trouvé !</span>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<p-dialog [(visible)]="filterDialog" [modal]="true" [draggable]="false" [resizable]="false" [style]="{width: '500px'}"
    header="Filtrer les voyages par période" styleClass="p-fluid">

    <ng-template pTemplate="content">
        <form [formGroup]="filterFormGroup">
            <div class="grid">
                <!-- Date de début -->
                <div class="col-12 md:col-6">
                    <label for="dateDebut" class="block mb-2 font-semibold">
                        Date de début <span class="text-red-500">*</span>
                    </label>
                    <p-calendar id="dateDebut" formControlName="dateDebut" dateFormat="dd/mm/yy" [showIcon]="true"
                        placeholder="Sélectionner une date" [maxDate]="filterFormGroup.get('dateFin')?.value">
                    </p-calendar>
                    <small class="text-red-500"
                        *ngIf="filterFormGroup.get('dateDebut')?.invalid && filterFormGroup.get('dateDebut')?.touched">
                        La date de début est requise
                    </small>
                </div>

                <!-- Date de fin -->
                <div class="col-12 md:col-6">
                    <label for="dateFin" class="block mb-2 font-semibold">
                        Date de fin <span class="text-red-500">*</span>
                    </label>
                    <p-calendar id="dateFin" formControlName="dateFin" dateFormat="dd/mm/yy" [showIcon]="true"
                        placeholder="Sélectionner une date" [minDate]="filterFormGroup.get('dateDebut')?.value">
                    </p-calendar>
                    <small class="text-red-500"
                        *ngIf="filterFormGroup.get('dateFin')?.invalid && filterFormGroup.get('dateFin')?.touched">
                        La date de fin est requise
                    </small>
                </div>

                <!-- Statuts -->
                <div class="col-12">
                    <label for="statutVoyages" class="block mb-2 font-semibold">
                        Statuts des vols
                    </label>
                    <p-multiSelect id="statutVoyages" formControlName="statutVoyages" appendTo="body" [options]="statutsVoyage"
                        optionLabel="label" optionValue="value" placeholder="Sélectionner les statuts" [filter]="true"
                        filterPlaceHolder="Rechercher..." [showClear]="true" display="chip">
                    </p-multiSelect>

                    <small class="text-gray-500">
                        Cocher tout pour tous les statuts
                    </small>
                </div>
            </div>
        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <div class="flex justify-content-end gap-2">
            <button pButton label="Annuler" icon="pi pi-times" class="p-button-text p-button-secondary"
                (click)="closeFilterDialog()">
            </button>
            <button pButton label="Réinitialiser" icon="pi pi-refresh" class="p-button-text p-button-warning"
                (click)="resetFilters()">
            </button>
            <button pButton label="Appliquer" icon="pi pi-check" class="p-button-primary"
                [disabled]="filterFormGroup.invalid" (click)="applyFilters()">
            </button>
        </div>
    </ng-template>
</p-dialog>

<!-- Toast pour les notifications -->
<p-toast [style]="{marginTop: '80px'}" position="top-center"></p-toast>

<!-- Dialog de confirmation -->
<p-confirmDialog></p-confirmDialog>
<app-loading-spinner></app-loading-spinner>