<div class="flex justify-between items-center mb-6">
  <h3 class="text-3xl font-semibold text-gray-800">Historique des Actions</h3>
  <button (click)="openPdfModal(actionsFiltrees(), 'Historique des Actions')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 flex items-center">
      <i class="fa-solid fa-file-pdf mr-2"></i>
      Exporter en PDF
  </button>
</div>

<!-- Section Filtres -->
<div class="mb-6 bg-white shadow-md rounded-lg p-6">
  <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
    <!-- Recherche par utilisateur -->
    <div class="md:col-span-12 lg:col-span-3">
      <label for="search" class="block text-sm font-medium text-gray-700">Utilisateur</label>
      <input type="text" id="search" name="search" [(ngModel)]="filtreRechercheUtilisateur" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white text-gray-900" placeholder="Nom de l'utilisateur...">
    </div>
    <!-- Type d'entité -->
    <div class="md:col-span-6 lg:col-span-3">
      <label for="type_action" class="block text-sm font-medium text-gray-700">Type d'entité</label>
      <select id="type_action" name="type_action" [(ngModel)]="filtreTypeAction" class="mt-1 block w-full pl-3 pr-10 py-2 border border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-md shadow-sm bg-white text-gray-900">
        <option value="">Tous</option>
        @for(type of typesAction(); track type) {
          <option [value]="type">{{type}}</option>
        }
      </select>
    </div>
     <!-- Action -->
    <div class="md:col-span-6 lg:col-span-2">
      <label for="action" class="block text-sm font-medium text-gray-700">Action</label>
      <select id="action" name="action" [(ngModel)]="filtreAction" class="mt-1 block w-full pl-3 pr-10 py-2 border border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-md shadow-sm bg-white text-gray-900">
        <option value="">Toutes</option>
        @for(action of actionsTypes; track action) {
          <option [value]="action">{{action}}</option>
        }
      </select>
    </div>
    <!-- Date début -->
    <div class="md:col-span-6 lg:col-span-2">
      <label for="date-debut" class="block text-sm font-medium text-gray-700">Date de début</label>
      <input type="date" id="date-debut" name="date-debut" [(ngModel)]="filtreDateDebut" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white text-gray-900">
    </div>
    <!-- Date fin -->
    <div class="md:col-span-6 lg:col-span-2">
      <label for="date-fin" class="block text-sm font-medium text-gray-700">Date de fin</label>
      <input type="date" id="date-fin" name="date-fin" [(ngModel)]="filtreDateFin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm bg-white text-gray-900">
    </div>
  </div>
</div>

<div class="bg-white shadow-lg rounded-lg overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateur</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Détail</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adresse IP</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        @for (action of actionsPaginees(); track action.id) {
          <tr class="hover:bg-emerald-50 transition-colors duration-200">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ action.date_action }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              {{ action.utilisateur }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="relative inline-block px-3 py-1 font-semibold leading-tight rounded-full text-xs" [class]="getActionClass(action.action)">
                {{ action.action }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              {{ action.detail_action }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <span class="font-mono">{{ action.adresse_ip }}</span>
            </td>
          </tr>
        } @empty {
           <tr>
            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center">
                <i class="fa-solid fa-file-circle-xmark text-4xl text-gray-300 mb-4"></i>
                <h4 class="text-lg font-semibold text-gray-600">Aucune action trouvée</h4>
                <p class="text-sm">Essayez de modifier vos filtres pour voir des résultats.</p>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="px-5 py-5 bg-white border-t flex flex-col xs:flex-row items-center xs:justify-between">
    <span class="text-xs xs:text-sm text-gray-900">
        {{ paginationText() }}
    </span>
    <div class="inline-flex mt-2 xs:mt-0 space-x-2">
        <button 
          (click)="pagePrecedente()"
          [disabled]="currentPage() === 1"
          class="text-sm font-semibold py-2 px-4 rounded transition duration-150 ease-in-out"
          [class]="currentPage() === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'">
            Précédent
        </button>
        <button 
          (click)="pageSuivante()"
          [disabled]="currentPage() === totalPages() || totalPages() === 0"
          class="text-sm font-semibold py-2 px-4 rounded transition duration-150 ease-in-out"
          [class]="(currentPage() === totalPages() || totalPages() === 0) ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-gray-300 hover:bg-gray-400 text-gray-800'">
            Suivant
        </button>
    </div>
  </div>
</div>

<!-- Modale PDF -->
@if (isPdfModalOpen()) {
  <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in" (click)="closePdfModal()">
    <div class="bg-gray-200 rounded-lg shadow-2xl p-4 max-w-5xl w-full h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center mb-4 pb-2 border-b">
        <h3 class="text-xl font-bold text-gray-800">{{ pdfContentTitle() }}</h3>
        <div class="flex items-center space-x-2">
            <button class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm flex items-center"><i class="fa-solid fa-print mr-2"></i>Imprimer</button>
            <button (click)="closePdfModal()" class="text-gray-400 hover:text-gray-600 transition-colors rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
      </div>
      <div class="flex-grow bg-white shadow-inner overflow-y-auto p-8 font-serif text-gray-800">
        @let data = pdfData();
        @if (data) {
          <!-- Contenu du PDF simulé -->
          <div class="w-full">
              <header class="flex justify-between items-center pb-4 border-b">
                  <div>
                      <h1 class="text-2xl font-bold">Aéroport</h1>
                      <p class="text-sm">Gestion des Voyageurs Aéroportuaires</p>
                  </div>
                  <div class="text-right">
                      <p class="text-sm">Généré le: {{ generatedDate }}</p>
                  </div>
              </header>

              <main class="mt-8">
                  <h2 class="text-xl font-semibold mb-4">{{ pdfContentTitle() }}</h2>
                  
                  <table class="min-w-full text-xs border-collapse border border-gray-300">
                      <thead class="bg-gray-100">
                          <tr>
                              <th class="border border-gray-300 p-2 text-left">Date</th>
                              <th class="border border-gray-300 p-2 text-left">Utilisateur</th>
                              <th class="border border-gray-300 p-2 text-left">Action</th>
                              <th class="border border-gray-300 p-2 text-left">Détail</th>
                              <th class="border border-gray-300 p-2 text-left">Adresse IP</th>
                          </tr>
                      </thead>
                      <tbody>
                          @for(item of data; track item.id) {
                              <tr>
                                  <td class="border border-gray-300 p-2">{{ item.date_action }}</td>
                                  <td class="border border-gray-300 p-2">{{ item.utilisateur }}</td>
                                  <td class="border border-gray-300 p-2">{{ item.action }}</td>
                                  <td class="border border-gray-300 p-2">{{ item.detail_action }}</td>
                                  <td class="border border-gray-300 p-2">{{ item.adresse_ip }}</td>
                              </tr>
                          }
                      </tbody>
                  </table>
              </main>

              <footer class="mt-16 pt-4 border-t text-center text-xs text-gray-500">
                  <p>Document confidentiel généré par le système Aéroport.</p>
              </footer>
          </div>
        }
      </div>
    </div>
  </div>
}
